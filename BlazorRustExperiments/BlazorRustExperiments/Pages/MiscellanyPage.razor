@page "/miscellany"
@using System.Runtime.InteropServices

<PageTitle>Calling Rust</PageTitle>
<h3>Calling Rust Miscellany</h3>
<Board @ref="board" />

@code {
    [DllImport(RLIB)] static extern void hello_world();
    [DllImport(RLIB)] static extern float hypotenuse(float x, float y);
    [DllImport(RLIB)] static extern int counter();

    // STRINGS
    [DllImport(RLIB)] static extern void print_string([MarshalAs(UnmanagedType.LPUTF8Str)] string text);
    // OR **
    // [DllImport(RLIB)] static extern void print_string(byte[] utf8Text);
    [DllImport(RLIB)] static extern IntPtr get_some_string();
    [DllImport(RLIB)] static extern IntPtr describe_person(int age);

    // STRUCTURES
    record struct Parallelepiped(float length, float width, float height);
    [DllImport(RLIB)] static extern IntPtr get_parallelepiped_ptr();
    [DllImport(RLIB)] static extern float get_parallelepiped_volume(Parallelepiped p);

    Board board;

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender) {
            Miscellany();
        }
    }

    void Miscellany()
    {
        hello_world(); // console output

        board.Add("**CALLING A MATH FUNCTION");
        float x = 9, y = 11, h = hypotenuse(x, y);
        board.Add(string.Format("From Rust Library, Hypotenuse({0}, {1}) = {2}\n", x, y, h));

        board.Add("**COUNTER FROM EMULATED CLOSURE");
        board.Add($"Counter: {counter()}");
        board.Add($"Counter: {counter()}");
        board.Add($"Counter: {counter()}");
        board.Add($"Counter: {counter()}");
        board.Add($"Counter: {counter()}\n");

        // STRINGS
        // ---------------------------------------------------------
        board.Add("**SENDING STRINGS");
        board.Add("Send a string to Rust (with extended characters)");

        var s = "« Quien descubre el quién soy descubrirá el quién eres » Neruda";

        board.Add($"print_string('{s}')", "brown");
        print_string(s);
        board.Add("See the browser console output\n", "coral");

        // ** ok: but moore complexity
        // print_string("« Esto es un árbol »".Utf8Text());

        // getting a string from lib
        board.Add("**GETTING STRINGS");

        var ptr = get_some_string();
        var text = Marshal.PtrToStringUTF8(ptr);
        // OR
        // var text = p.TextFromPointer();

        board.Add($"String pointer : {ptr}");
        board.Add($"Dereferenced   : {text}\n");

        board.Add("**STRING FUNCTION");
        var age = 18;
        var desc = describe_person(age); // this is a pointer
        board.Add(string.Format("describe_person(age: 18) : {0}\n", desc.TextFromPointer()));

        board.Add("**STRUCTURES");

        var structPointer = get_parallelepiped_ptr();
        var parallelepiped = Marshal.PtrToStructure<Parallelepiped>(structPointer);
        var volume = get_parallelepiped_volume(parallelepiped);

        // show it
        board.Add($"Get pointer       : {structPointer}");
        board.Add($"Marshal to Struct : {parallelepiped}");
        board.Add($"Length            : {parallelepiped.length:N2}");
        board.Add($"Width             : {parallelepiped.width:N2}");
        board.Add($"Height            : {parallelepiped.height:N2}\n");
        board.Add("Call a rust function passing a C# struct as parameter");
        board.Add($"Volume            : {volume:N2}");
    }
}
